<script src="/client-socket/socket.io.js"></script>
<script src="/gridstack/gridstack-h5.js"></script>
<link href="/gridstack/gridstack.min.css" rel="stylesheet"/>


<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    google.charts.load("current", {
        packages: ["corechart", "line", "gauge"]
    });
</script>
 <style type="text/css">
        /*.grid-stack { background: #fff; }*/
        .grid-stack-item-content { background-color: #fff; }
    </style>
<!--=======================================================================================================================================-->
<!--=======================================================================================================================================-->
<!--=======================================================================================================================================-->
<!--=======================================================================================================================================-->


<div class="nav-superior shadow rounded my-auto">
    
    <!--  BREADCRUMB  -->
    <ol class="nav-superior__breadcrumb m-0 breadcrumb">        
        <li class="breadcrumb-item"><a href="/dashboard">TABLERO</a></li>
        <li class="breadcrumb-item active" aria-current="page">Control de dispositivos</li>
    </ol>
    
    <!--  SELECTOR DISPOSITIVO -->
    <div class="buttons row">
        <div class="col-6" style="display: flex; align-self:center;justify-content:flex-end;">
            <b class="font-weight-light">Seleccionar dispositivo:</b>
        </div>
        <div class="col-6"  id="select_devices_user">            
        </div>  
    </div>
</div>

<div class="contenido-principal" id="cant_devices">
</div>
<table class="table table-striped bg-light text-center my-auto">
        <thead>
            <tr>
            <th scope="col">ID</th>
            <th scope="col">NOMBRE</th>
            <th scope="col">DESCRIPCIÓN</th>
            <th scope="col">VALORES</th>
            <th scope="col">CONTROL</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <th scope="row">1</th>
                <td>Set Point<br>Temperatura</td>
                <td>Regularizable</td>
                <td>
                    <span class="badge badge-danger d-block">Máxima: 28 °C</span>
                    <span class="badge badge-dark d-block mt-1">Normal: 24 °C</span>
                    <span class="badge badge-warning d-block mt-1">Mínima: 20 °C</span>
                </td>
                <td>
                    <span class="badge badge-success d-block">En Rango</span>
                    <span class="text-center mt-1 d-block"> 23.7 °C</span>
                </td>
            </tr>
            <tr>
                <th scope="row">2</th>
                <td>RELE001</td>
                <td>Iluminación patio A1</td>
                <td>-</td>
                <td class="text-center"><input type="checkbox" data-toggle="toggle" data-onstyle="success" data-offstyle="danger"></td>
            </tr>
            <tr>
                <th scope="row">3</th>
                <td>RELE002</td>
                <td>Estacionamiento E2</td>
                <td>-</td>
                <td class="text-center"><input type="checkbox" checked data-toggle="toggle" data-onstyle="success" data-offstyle="danger"></td>
            </tr>
            <tr>
                <th scope="row">4</th>
                <td>RELE003</td>
                <td>Casino Sector F</td>
                <td>-</td>
                <td class="text-center"><input type="checkbox" checked data-toggle="toggle" data-onstyle="success" data-offstyle="danger"></td>
            </tr>
        </tbody>
        </table>


    <!--<div class="col-12 bg-light rounded">
        <div id="chart_div" class="bg-light rounded" style="height: 350px;"></div>
    </div>
    <div class="col-4 mt-3 bg-light rounded">
        <table class="table table-striped bg-light text-center my-auto">
        <thead>
            <tr>
            <th scope="col">ID</th>
            <th scope="col">NOMBRE</th>
            <th scope="col">DESCRIPCIÓN</th>
            <th scope="col">VALORES</th>
            <th scope="col">CONTROL</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <th scope="row">1</th>
                <td>Set Point<br>Temperatura</td>
                <td>Regularizable</td>
                <td>
                    <span class="badge badge-danger d-block">Máxima: 28 °C</span>
                    <span class="badge badge-dark d-block mt-1">Normal: 24 °C</span>
                    <span class="badge badge-warning d-block mt-1">Mínima: 20 °C</span>
                </td>
                <td>
                    <span class="badge badge-success d-block">En Rango</span>
                    <span class="text-center mt-1 d-block"> 23.7 °C</span>
                </td>
            </tr>
            <tr>
                <th scope="row">2</th>
                <td>RELE001</td>
                <td>Iluminación patio A1</td>
                <td>-</td>
                <td class="text-center"><input type="checkbox" data-toggle="toggle" data-onstyle="success" data-offstyle="danger"></td>
            </tr>
            <tr>
                <th scope="row">3</th>
                <td>RELE002</td>
                <td>Estacionamiento E2</td>
                <td>-</td>
                <td class="text-center"><input type="checkbox" checked data-toggle="toggle" data-onstyle="success" data-offstyle="danger"></td>
            </tr>
            <tr>
                <th scope="row">4</th>
                <td>RELE003</td>
                <td>Casino Sector F</td>
                <td>-</td>
                <td class="text-center"><input type="checkbox" checked data-toggle="toggle" data-onstyle="success" data-offstyle="danger"></td>
            </tr>
        </tbody>
        </table>
    </div>
    <div class="col-4 mt-3 px-2 rounded">
        <div class="row bg-light mx-2">
            <div class="col-12">
                <form class="p-4">
                    <div class="form-group">
                        <label for="setpoint">Establecer Variable de control</label>
                        <input type="number" class="form-control" id="setpoint" aria-describedby="setpoint" placeholder="Ingresar valor">
                        <small id="setpoint" class="form-text text-muted">El valor varia entre 0.00 - 50.00 °C</small>
                    </div>
                    <div class="form-group">
                        <label for="setpoint">Establecer Variable de control Máxima</label>
                        <input type="number" class="form-control" id="setpoint" aria-describedby="setpoint" placeholder="Ingresar valor">
                        <small id="setpoint" class="form-text text-muted">El valor varia entre 0.00 - 50.00 °C</small>
                    </div>
                    <div class="form-group">
                        <label for="setpoint">Establecer Variable de control Mínima</label>
                        <input type="number" class="form-control" id="setpoint" aria-describedby="setpoint" placeholder="Ingresar valor">
                        <small id="setpoint" class="form-text text-muted">El valor varia entre 0.00 - 50.00 °C</small>
                    </div>
                    <button type="submit" class="btn btn-primary mx-0 px-5 d-inline text-center">Enviar</button>
                    <button type="reset" class="btn btn-primary mx-0 px-5 d-inline text-center">Restablecer Parámetros</button>
</form>
            </div>
        </div>
    </div>
    <div class="col-4 mt-3 bg-light rounded" style="display: flex; align-items:center; justify-content: center;">
        <div id="chart_div2"></div>
    </div>-->

    <!--

    
    <script type="text/javascript">
      // load current chart package
        google.charts.load("current", {
            packages: ["corechart", "line", "gauge"]
        });
        // set callback function when api loaded
        google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
  // create data object with default value
  let data = google.visualization.arrayToDataTable([
    ["Year", "CPU Usage"],
    [0, 0]
  ]);
  // create options object with titles, colors, etc.
  let options = {
    title: "CPU Usage",
    hAxis: {
      title: "Tiempo"
    },
    vAxis: {
      title: "Variable"
    }
  };
  // draw chart on load
  let chart = new google.visualization.LineChart(
    document.getElementById("chart_div")
  );
  chart.draw(data, options);
  let index = 0;
  socket.on("factorb-iot-0000", sensores => {
      console.log("mensaje sensores: ", sensores.distance);
      data.addRow([index, sensores.distance]);
      chart.draw(data, options);
      index++;
  });
  
setInterval(function() {
  // instead of this random, you can make an ajax call for the current cpu usage or what ever data you want to display
  let random = Math.random() * 30 + 20;
  
}, 500);
}

    google.charts.setOnLoadCallback(drawChart2);

      function drawChart2() {

        var data2 = google.visualization.arrayToDataTable([
          ['Label', 'Value'],
          ['Memory', 80],
          ['CPU', 12],
          ['RAM', 23]
        ]);

        var options2 = {
          width: 600, height: 220,
          redFrom: 90, redTo: 100,
          yellowFrom:75, yellowTo: 90,
          minorTicks: 5,
        };

        var chart2 = new google.visualization.Gauge(document.getElementById('chart_div2'));

        chart2.draw(data2, options2);

        setInterval(function() {
          data2.setValue(0, 1, 40 + Math.round(60 * Math.random()));
          chart2.draw(data2, options2);
        }, 1000);
        setInterval(function() {
          data2.setValue(1, 1, 40 + Math.round(60 * Math.random()));
          chart2.draw(data2, options2);
        }, 1000);
        setInterval(function() {
          data2.setValue(2, 1, 60 + Math.round(20 * Math.random()));
          chart2.draw(data2, options2);
        }, 1000);
      }
    </script>-->
    
    
    


<script>


    axios(
      { 
          method: 'POST', 
          url: '{{url}}/api/search_devices', 
          headers: {
              Authorization: "Bearer Token"
          }, 
          data: { 
              id: 10 
          }
      }
    ).then((res) => {
        
        console.log(res.data);
        let cant_devices = `<div class="row">`;
        let selected = `
            <select onchange="change_device()" class="form-control d-inline" id="devices">
            <option value=0 selected>${res.data.data.length} Dispositivos Encontrados</option>
        `;
      
        if(res.data.data.length !== 0) {
            
            for(let i = 0 ; i < res.data.data.length ; i ++) {

                selected = selected + `<option value=${res.data.data[i].id} >${res.data.data[i].name}</option>`;
                cant_devices = cant_devices + `
                    <div class="col-2">
                            <button class="btn btn-primary btn-block" onclick="ver_dispositivo(${res.data.data[i].id}, '${res.data.data[i].socket_name}')">${res.data.data[i].name}</button>
                    </div>`;
            }
        }
        else {
            
            selected = selected + `<option value=0 >0 dispositivos registrados.</option>`;
        }
        cant_devices = cant_devices + `</div>`;
        selected = selected + `</select>`;
        document.getElementById('select_devices_user').innerHTML = selected;
        document.getElementById('cant_devices').innerHTML = cant_devices;

    }).catch((err) => {
        
        console.log(err);
    });
    
    //var grid = GridStack.init();
    
    function change_device() {
        
        let id_device = document.getElementById('devices').value;
        
        if(id_device != 0) {
            axios(
                {
                    method: 'POST',
                    url: 'http://127.0.0.1:3000/api/search_sensors',
                    headers: {
                        Authorization: "Bearer Token"
                    }, 
                    data: { 
                        id: id_device
                    }
                }
            ).then((res) => {
                
                console.log(res.data);

                var items = [
                    {
                        w: 12,
                        h:3,
                        content: `
                            ${res.data.data.length} Dispositivos Encontrados
                            
                            
                            
                           
                            
                            
                        `
                    }
                ];
                
                //grid.removeAll();
                //grid.load(items);

            }).catch((err) => {
                
                console.log(err);
            });
        }
        else {
        
            //grid.removeAll();
        } 
    }       

    function ver_dispositivo(id, socket_name) {
        window.location.href = "/dashboard/device/" + id + "/" + socket_name;
    }   
</script>